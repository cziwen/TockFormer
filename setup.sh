#!/bin/bash

####################################################################################
# ğŸ¤– setup.sh - è¿è¡Œäº RunPod å®¹å™¨ä¸­çš„åˆå§‹åŒ–è„šæœ¬
#
# âœ… ç”¨é€”ï¼š
#   - è®¾ç½® SSH æƒé™ï¼Œæ·»åŠ ç§é’¥åˆ° ssh-agent
#   - æµ‹è¯• SSH æ˜¯å¦èƒ½è¿æ¥ GitHubï¼ˆç”¨äºç§æœ‰ä»“åº“æ‹‰å–ï¼‰
#   - è‡ªåŠ¨å®‰è£… requirements.txt ä¸­çš„ Python ä¾èµ–
#
# âš ï¸ æ³¨æ„ï¼š
#   - åœ¨è¿è¡Œæœ¬è„šæœ¬ä¹‹å‰ï¼Œä½ å¿…é¡»å…ˆä»æœ¬åœ°ä½¿ç”¨ scp ä¸Šä¼  SSH ç§é’¥åˆ°å®¹å™¨ï¼š
#     ç¤ºä¾‹å‘½ä»¤ï¼ˆåœ¨æœ¬åœ°ç»ˆç«¯æ‰§è¡Œï¼‰ï¼š
#     scp -P <PORT> ~/.ssh/id_ed25519 root@<IP_ADDRESS>:/root/.ssh/
#
#   - ç„¶åè¿›å…¥å®¹å™¨åï¼Œè¿è¡Œï¼š
#     bash setup.sh
####################################################################################

echo "ğŸ” Step 1: è®¾ç½® .ssh æƒé™"
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519

echo "âš™ï¸ Step 2: å¯åŠ¨ ssh-agent å¹¶æ·»åŠ ç§é’¥"
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519

echo "ğŸ”— Step 3: æµ‹è¯• SSH æ˜¯å¦èƒ½è¿ä¸Š GitHub"
ssh -T git@github.com || {
    echo "âŒ SSH è¿æ¥ GitHub å¤±è´¥ï¼Œè¯·ç¡®è®¤ä½ å·²å°†æœ¬åœ°å…¬é’¥æ·»åŠ åˆ° GitHub"
    exit 1
}

echo "ğŸ“¦ Step 4: å®‰è£… Python ä¾èµ–"
if [ -f requirements.txt ]; then
    pip install -r requirements.txt
else
    echo "âš ï¸ requirements.txt ä¸å­˜åœ¨ï¼Œè¯·ç¡®è®¤è·¯å¾„æ­£ç¡®"
fi

echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆï¼ç°åœ¨å¯ä»¥æ­£å¸¸è®­ç»ƒã€git æ“ä½œå•¦ ğŸš€"